<!DOCTYPE html>
<html lang="en">
<head>
<link rel=stylesheet type="text/css" href="stylesheet.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="stringToRegexp.js"></script>
    <script src="getRegexpResultArray.js"></script>
    <script src="addResultToTextArea.js"></script>
    <script src="splitResultOfTextArea.js"></script>
    <script src="getExamObjectArray.js"></script>
    <title>BDD TEST Document</title>
</head>
<body style>
    <div class="questionsAndAnswersContainer" id="questionsAndAnswersContainer">
        <textarea class="texebox" name="textarea" id="questionsAndAnswers"></textarea>
    </div>
    <div class="patternContainer" id="patternContainer">
      <table>
<tr>
  <th><label for="questionsNumbersPattern">題號樣式:</label></th>
  <td>
        <select class="choose" name="questionsNumbersPattern" id="questionsNumbersPattern">
              <option value="^(\d{1,3})(?!\.)\s{0,3}/gmu">題號無小數點</option>
              <option value="^(\d{1,3}\.)\s{0,3}/gmu">題號有小數點</option>
          </select>
</td>
</tr>
<tr>
  <th><label for="answersPattern">答案樣式:</label></th>
  <td>
            <select class="choose" name="answersPattern" id="answersPattern">
                  <option value="^([ABCDE])\s\d{1,3}(?!\.)\s{0,3}/gmu">答案在前，題號無小數點</option>
                  <option value="^([ABCDE])\s\d{1,3}\.\s{0,3}/gmu">答案在前，題號有小數點</option>
                  <option value="^\d{1,3}(?!\.)\s{0,3}([ABCDE])\s/gmu">答案在後，題號無小數點</option>
                  <option value="^\d{1,3}\.\s{0,3}([ABCDE])\s/gmu">答案在後，題號有小數點</option>
              </select>
</td>
</tr>
<tr>
  <th><label for="questionsPattern">題目樣式:</label></th>
  <td>
        <select class="choose" name="questionsPattern" id="questionsPattern">
              <option value="^\d{1,3}(?!\.)\s{0,3}[ABCDE]\s([\s\S]+?)(?=\(a\)\s{0,3}[\s\S]+?\(b\)\s{0,3}[\s\S]+?\(c\)\s{0,3}[\s\S]+?\(d\)\s{0,3}[\s\S]+?(?:\(e\)\s{0,3}[\s\S]+?)?(?=^\d{1,3}|$))/gmu">test3</option>
              <option value="^\d{1,3}\.\s{0,3}[ABCDE]\s([\s\S]+?)(?=\(A\)\s{0,3}[\s\S]+?\(B\)\s{0,3}[\s\S]+?\(C\)\s{0,3}[\s\S]+?\(D\)\s{0,3}[\s\S]+?(?:\(E\)\s{0,3}[\s\S]+?)?(?=^\d{1,3}|$))/gmu">test4</option>
          </select>
</td>
</tr>
<tr>
  <th><label for="choicesPattern">選項樣式:</label></th>
  <td>
        <select class="choose" name="choicesPattern" id="choicesPattern">
              <option value="\(A\)\s{0,3}([\s\S]+?)\(B\)\s{0,3}([\s\S]+?)\(C\)\s{0,3}([\s\S]+?)\(D\)\s{0,3}([\s\S]+?)(?:\(E\)\s{0,3}([\s\S]+?))?(?=^\d{1,3}\.|$)/gmu">選項不在行首，題號有小數點</option>
              <option value="\(a\)\s{0,3}([\s\S]+?)\(b\)\s{0,3}([\s\S]+?)\(c\)\s{0,3}([\s\S]+?)\(d\)\s{0,3}([\s\S]+?)(?:\(e\)\s{0,3}([\s\S]+?))?(?=^\d{1,3}|$)/gmu">選項不在行首，題號無小數點</option>
              <option value="^\(A\)\s{0,3}([\s\S]+?)^\(B\)\s{0,3}([\s\S]+?)^\(C\)\s{0,3}([\s\S]+?)^\(D\)\s{0,3}([\s\S]+?)(?:^\(E\)\s{0,3}([\s\S]+?))?(?=^\d{1,3}\.\s[ABCDE]|$)/gmu">選項在行首，答案在後，題號有小數點</option>
              <option value="^\(A\)\s{0,3}([\s\S]+?)^\(B\)\s{0,3}([\s\S]+?)^\(C\)\s{0,3}([\s\S]+?)^\(D\)\s{0,3}([\s\S]+?)(?:^\(E\)\s{0,3}([\s\S]+?))?(?=^[ABCDE]\s\d{1,3}\.|$)/gmu">選項在行首，答案在前，題號有小數點</option>
              <option value="^\(a\)\s{0,3}([\s\S]+?)^\(b\)\s{0,3}([\s\S]+?)^\(c\)\s{0,3}([\s\S]+?)^\(d\)\s{0,3}([\s\S]+?)(?:^\(e\)\s{0,3}([\s\S]+?))?(?=^\d{1,3}\s[ABCDE]\s|$)/gmu">選項在行首，答案在後，題號無小數點</option>
              <option value="^\(a\)\s{0,3}([\s\S]+?)^\(b\)\s{0,3}([\s\S]+?)^\(c\)\s{0,3}([\s\S]+?)^\(d\)\s{0,3}([\s\S]+?)(?:^\(e\)\s{0,3}([\s\S]+?))?(?=^[ABCDE]\s\d{1,3}\s|$)/gmu">選項在行首，答案在前，題號無小數點</option>
          </select>
</td>
</tr>
</table>
<input class="button" id="applyAllPattern" type="button" value="套用樣式進行篩選">
<input class="button" id="btn" type="button" value="產生考卷">
    </div>
    <div id="containerOfResult">
          <label class="flex-column" id="promptOfResultOfGetQuestionsNumbers">
		  <text class="text">題號篩選結果:</text>
          <textarea class="item1" id="ResultOfGetQuestionsNumbers"></textarea>
		  </label>
          <label class="flex-column" id="promptOfResultOfAnswers">
		  <text class="text">答案篩選結果:</text>
          <textarea class="item1" id="ResultOfAnswers"></textarea>
		  </label>
          <label class="flex-column" id="promptOfResultOfGetQuestions">
		  <text class="text">題目篩選結果:</text>
          <textarea class="item2" id="ResultOfGetQuestions"></textarea>
		  </label>
          <label class="flex-column" id="promptOfResultOfChoices">
		  <text class="text">選項篩選結果:</text>
          <textarea class="item2" id="ResultOfChoices"></textarea>
		  </label>
    </div>
    <script>
        let selectOfQuestionsNumbersPattern = document.getElementById('questionsNumbersPattern');
        let optionsOfQuestionsNumbersPattern = selectOfQuestionsNumbersPattern.options;
        let questionsAndAnswers = document.getElementById('questionsAndAnswers');
        function applyQuestionsNumbersPattern () {
          let labelId = 'promptOfResultOfGetQuestionsNumbers';
          let textAreaId = 'ResultOfGetQuestionsNumbers';
          let questionsNumbersPattern = optionsOfQuestionsNumbersPattern[optionsOfQuestionsNumbersPattern.selectedIndex].value;
          let questionsNumbersArray = getRegexpResultArray(questionsAndAnswers.value, questionsNumbersPattern);
          if (questionsNumbersArray.length !== 0) {
              addResultToTextArea(questionsNumbersArray, textAreaId, labelId);
          }
        }
        selectOfQuestionsNumbersPattern.addEventListener('change', applyQuestionsNumbersPattern);
        let selectOfChoicesPattern = document.getElementById('choicesPattern');
        let optionsOfChoicesPattern = selectOfChoicesPattern.options;
        function applyChoicesPattern () {
          let labelId = 'promptOfResultOfChoices';
          let textAreaId = 'ResultOfChoices';
          let choicesObject = { choices:[]};
          let choicesPattern = optionsOfChoicesPattern[optionsOfChoicesPattern.selectedIndex].value;
          let choicesArray = getRegexpResultArray(questionsAndAnswers.value, choicesPattern, choicesObject);
          if (choicesArray.length !== 0) {
            addResultToTextArea(choicesArray, textAreaId, labelId);
          }
        }
        selectOfChoicesPattern.addEventListener('change', applyChoicesPattern);
        let selectOfAnswersPattern = document.getElementById('answersPattern');
        let optionsOfAnswersPattern = selectOfAnswersPattern.options;
        function applyAnswersPattern () {
          let labelId = 'promptOfResultOfAnswers';
          let textAreaId = 'ResultOfAnswers';
          let answersPattern = optionsOfAnswersPattern[optionsOfAnswersPattern.selectedIndex].value;
          let answersArray = getRegexpResultArray(questionsAndAnswers.value, answersPattern);
          if (answersArray.length !== 0) {
            addResultToTextArea(answersArray, textAreaId, labelId);
          }
        }
        selectOfAnswersPattern.addEventListener('change', applyAnswersPattern);
        let selectOfQuestionsPattern = document.getElementById('questionsPattern');
        function applyQuestionsPattern () {
          let optionsOfQuestionsPattern = selectOfQuestionsPattern.options;
          let labelId = 'promptOfResultOfGetQuestions';
          let textAreaId = 'ResultOfGetQuestions';
          let choicesPattern = optionsOfChoicesPattern[optionsOfChoicesPattern.selectedIndex].value;
          console.log(choicesPattern);
          let questionsNumbersPattern = optionsOfQuestionsNumbersPattern[optionsOfQuestionsNumbersPattern.selectedIndex].value;
          let answersPattern = optionsOfAnswersPattern[optionsOfAnswersPattern.selectedIndex].value;
          let test = function removeCaptureGroupParentheses(choicesPattern) {
            return choicesPattern.replace(/\(\[\\s\\S\]\+\?\)/gmu,'[\\s\\S]+?');
          }(choicesPattern);
          console.log(test);
          let test2 = function removeCaptureGroupParentheses(questionsNumbersPattern) {
            return questionsNumbersPattern.replace(/\^\(\\d\{1,3\}\\\.\)/,'^\\d{1,3}\\.');
          }(questionsNumbersPattern);
          let test3 = function removeCaptureGroupParentheses(answersPattern) {
            return answersPattern.replace(/\(\[ABCDE\]\)/,'[ABCDE]');
          }(answersPattern);
          let questionsPattern = test3.replace(/\/gmu/,'') + '([\\s\\S]+?)(?=' + test.replace(/\/gmu/,')/gmu');
          let questionsArray = getRegexpResultArray(questionsAndAnswers.value, questionsPattern);
          if(questionsArray.length !== 0){
              addResultToTextArea(questionsArray, textAreaId, labelId);
          }
        }
        selectOfQuestionsPattern.addEventListener('change', applyQuestionsPattern);
        let btn = document.getElementById('btn');
        let applyPatternBtn = document.getElementById('applyAllPattern');
        applyPatternBtn.addEventListener('click', () => {
            applyQuestionsNumbersPattern();
            applyAnswersPattern();
            applyChoicesPattern();
            applyQuestionsPattern();
        })
        let examObject;
        function createExamHtml () {
          let textareaContainer = {qa: undefined, ans: undefined, options: undefined};
          textareaContainer.qa = document.getElementById('ResultOfGetQuestions');
          textareaContainer.ans = document.getElementById('ResultOfAnswers');
          textareaContainer.options = document.getElementById('ResultOfChoices');
          examObject = getExamObjectArray(textareaContainer);
          makeTable(examObject);
        }
        btn.addEventListener('click', createExamHtml);

        var correctArray = [];
        function makeTable (data) {
          function shuffle(array) {
            var currentIndex = array.length, temporaryValue, randomIndex;
            // While there remain elements to shuffle...
            while (0 !== currentIndex) {
              // Pick a remaining element...
              randomIndex = Math.floor(Math.random() * currentIndex);
              currentIndex -= 1;
              // And swap it with the current element.
              temporaryValue = array[currentIndex];
              array[currentIndex] = array[randomIndex];
              array[randomIndex] = temporaryValue;
            }
            return array;
          }
          if (!data) {
              return;
            }
          shuffle(data);
          let table = document.createElement('table');
          let tbody = document.createElement('tbody');
          let tr = document.createElement('tr');
          let td = document.createElement('td');
          let ol = document.createElement('ol');
          for (let j = 0, len = data.length; j < len; j++) {
            let tr = document.createElement('tr');
            let td = document.createElement('td');
            let ol = document.createElement('ol');
            ol.start = j + 1;
            shuffle(data[j].options);
            correctArray.push(data[j].ans);
            let cAnsLen = data[j].ans.length;
            let li = document.createElement('li');
            li.id = 'li_' + j;
            let liText = document.createTextNode(data[j].qa);
            li.appendChild(liText);
            let ol2 = document.createElement('ol');
            for (let i = 0, len2 = data[j].options.length; i < len2; i++) {
              let tempStr = data[j].options[i];
              let li2 = document.createElement('li');
              let objLabel = document.createElement('label');
              objLabel.id = 'lbl_' + j + '_' + i;
              if (cAnsLen === 1) {
                let radioText = document.createTextNode(tempStr);
                let objRadio = document.createElement('input');
                objRadio.type = 'radio';
                objRadio.name = 'singleChoicesGroup_' + j;
                objRadio.id = 'singleChoiceId_' + j + '_' + i;
                objRadio.value = i + 1;
                objLabel.htmlFor = objRadio.id;
                objLabel.appendChild(objRadio);
                objLabel.appendChild(radioText);
                li2.appendChild(objLabel);                
              } else {
                let chkText = document.createTextNode(tempStr);
                let objChk = document.createElement('input');
                objChk.type = 'checkbox';
                objChk.name = 'multipleChoicesGroup_' + j;
                objChk.id = 'multipleChoiceId_' + j + '_' + i;
                objLabel.htmlFor = objChk.id;
                objLabel.appendChild(objChk);
                objLabel.appendChild(chkText);
                li2.appendChild(objLabel);
              }
              ol2.appendChild(li2);
              li.appendChild(ol2);
              ol.appendChild(li);              
              td.appendChild(ol);
              tr.appendChild(td);
              tbody.appendChild(tr);
            }
          }
          tbody.addEventListener('click', function delegateOfCheck(e) {
            let event = e || window.event;
            let target = event.target || event.srcElement;                
            let id = target.id;            
            function disableEles(eles) {
              for(let i = 0; i < eles.length; i++) {
                eles[i].disabled = true;
              }
            }
            if (target.type === 'radio') {
              let qNum = id.match(/_(\d)_/)[1];
              let optNum = id.match(/_\d_(\d)/)[1];
              let radioEle = document.getElementById(id);
              let optText = radioEle.nextSibling.textContent;
              if (radioEle.checked) {
                if (optText === correctArray[qNum][0]) {
                  radioEle.className += 'correctAns';                  
                  let radioGroup = document.querySelectorAll(
                    'li input[name = singleChoicesGroup_' + qNum + ']'
                  );
                  disableEles(radioGroup);
                }
              }
            } else if (target.type === 'checkbox') {
              let qNum = id.match(/_(\d)_/)[1];
              let optNum = id.match(/_\d_(\d)/)[1];
              let checkboxGroup = document.querySelectorAll(
                'li input[name = multipleChoicesGroup_' + qNum + ']'
              );              
              let cAnsLen = correctArray[qNum].length;
              let selected = [];
              let checkedPosition = [];
              let correctTimes = 0;
              for (let i = 0, len = checkboxGroup.length; i < len; i++) {
                if (checkboxGroup[i].checked) {
                  checkedPosition.push(i);                  
                  selected.push(checkboxGroup[i].nextSibling.textContent);                  
                }
              }
              for (let p = 0; p < selected.length; p++) {
                for (let k = 0; k < cAnsLen; k++) {
                  if (selected[p] === correctArray[qNum][k]) {
                    correctTimes++;
                    break;
                  }
                }
              }
              if (correctTimes === cAnsLen && selected.length === cAnsLen) {
                for(let i = 0; i < checkedPosition.length; i++) {
                  checkboxGroup[checkedPosition[i]].className = 'correctAns';
                }
                disableEles(checkboxGroup);                
              }
            }
          }, false)
          table.appendChild(tbody);
          document.body.appendChild(table);
        }
    </script>
</body>
</html>
